name: Build Jekyll site

on:
  workflow_dispatch: {}
  push:
    paths:
      - "src/**"

permissions:
  contents: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  SRC_PATH: "src"
  DST_PATH: "docs"
  PRO_BRANCH: "main"
  DEV_REPO: "${{ github.repository_owner }}/davidosuna-linktree-dev"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1.255.0
        with:
          ruby-version: '3.1' # Not needed with a .ruby-version file
          bundler-cache: true # runs 'bundle install' and caches installed gems automatically
          cache-version: 0 # Increment this number if you need to re-download cached gems
          working-directory: ${{ env.SRC_PATH }}
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5
      - name: Build with Jekyll
        working-directory: ${{ env.SRC_PATH }}
        run: bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}" --destination ../${{ env.DST_PATH }}
        env:
          JEKYLL_ENV: production
      - name: Commit built page
        uses: EndBug/add-and-commit@v9
        with:
          add: "${{ env.DST_PATH }}/*"
          push: true
          message: Update built site

  push-dev:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref != 'refs/heads/${{ env.PRO_BRANCH }}'
    env:
      PRO_REPO_PATH: "main"
      DEV_REPO_PATH: "dev"
    steps:
      - name: Checkout PRO repo
        uses: actions/checkout@v5
        with:
          path: ${{ env.PRO_REPO_PATH }}
      - name: Checkout DEV repo
        uses: actions/checkout@v5
        with:
          repository: ${{ env.DEV_REPO }}
          path: ${{ env.DEV_REPO_PATH }}
      - name: Copy PRO sources to DEV repo
        run: rm * && cp -r ${{ env.PRO_REPO_PATH }}/${{ env.DST_PATH }}/* ${{ env.DEV_REPO_PATH }}
      - name: Commit built page
        uses: EndBug/add-and-commit@v9
        with:
          cwd: ${{ env.DEV_REPO_PATH }}
          push: true
          message: Update built site (DEV)
